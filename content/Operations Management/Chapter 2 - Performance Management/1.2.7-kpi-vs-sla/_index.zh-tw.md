---
title: "7. 關鍵績效指標和服務水平協議"
date: 2021-06-13T15:12:21+10:00
draft: false
weight: 70
---

我同意一組確定複雜對象（例如 VM 或應用程序）運行狀況的指標在 100% 的情況下永遠不會準確。這很正常，就像在現實生活中一樣。我們進行年度健康檢查，進行各種測試，結果將是一系列指標（例如您的壞膽固醇水平）。從年輕到年老，它們對您來說是否 100% 準確？結果是否對您所在城市的每個人都 100% 準確？不，但它們已經足夠好了，而且肯定比沒有好得多。除了絕對值之外，值隨時間的相對變動也能讓您洞察力。例如，如果 KPI 在一個安靜的星期天早上下降，而環境不應該有已知活動，那麼可能有不好的事情發生？

在這本書中，我對 KPI 的定義嚴格按照**性能**，因為性能這個詞有特定的含義。對我來說，KPI 作為一個術語不適用於可用性管理和容量管理。我們應該將決定可用性的關鍵指標稱為**KAI**，將決定容量的關鍵指標稱為**KCI**[^1]。這將防止混淆，因為實現級解決方案要求我們明確術語。

本書沒有使用包括非績效在內的更廣泛的 KPI 定義，因此我們可以在實現中精確。對於整體業務KPI, [Norman Dee](https://blogs.vmware.com/services-education-insights/author/ndee) 寫了一系列的博客文章[這裡](https://blogs.vmware.com /services-education-insights/2020/05/getting-started-with-kpis-and-metrics-part-1-their-importance-and-value.html).

要使 KPI 支持 SLA，它使用的閾值必須與 SLA 使用的閾值相同。

假設您有三類服務，其中 Gold 是最高和最貴的。

黃金級應該比青銅級表現更好。這是期望，所以我們需要在實際生產中反映這一點。 Gold _absolute_ 性能應該更好，因為它被設計得更好。一開始它的價格更高是有原因的。

#### KPI

這種絕對性能的測量範圍是 0 - 100%，因此很容易理解，100% 是最好的。從數學上講，KPI 實際上是無單位的。我可以選擇另一個範圍，例如 0 - 4，它不會有任何區別。使用百分比和 0 - 100 只會更容易記住。

**KPI** 按原樣報告原始性能。

大多數 KPI 是內部的。它們用作故障排除的起點。

對於每種類型的對象，旨在將所有績效指標整合到一個 KPI 中。假設您有 1000 個要監控的 AWS EC2。您有一堆指標，並將它們考慮為 2 個 KPI。您如何知道哪個 EC2 有問題？您需要顯示 2 組熱圖或表。這意味著您需要手動將第一個表與第二個表相關聯。它不可擴展。

當您滾動到更高級別的對象時，上述內容也帶來了挑戰。

#### SLA

雖然 Gold 的表現應該比 Silver 好，但對於 Gold SLA 來說可能還不夠好。儘管黃金在絕對意義上比青銅快，但它自己的 SLA 也可能會失敗。相對以二進制來衡量。通過或失敗。因為它是一個二進製文件，它無法衡量它通過的好壞或失敗的壞。這是 KPI 對其進行補充的一個領域。

**SLA** 通常在一個日曆月內進行衡量，這意味著 5 分鐘的一次故障不構成正式的 SLA 故障。

SLA 是外部的，因為它寫在合同中。

-----

下表顯示了 KPI 和 SLA 之間的關係。兩者都採用相同的指標和閾值作為輸入，但由於目的不同，它們的分析方式不同。

![絕對術語圖](1.2.7-fig-1.png)

所有三個服務類別共享相同的 KPI 集，這些 KPI 是絕對的。快就是快。這是事實，無論您貼上什麼商業標籤。

- 要定義您的 KPI，請獲取每個 KPI 指標並準確定義速度，並將其分為四個區域。為簡單起見，每個區域都給出了 100% 的四分之一。
- 理想情況下，將 Gold SLA 設置在最高範圍，即 KPI 的綠色範圍。
- 理想情況下，將 Silver SLA 設置在綠色以下的範圍內，即 KPI 的黃色範圍。如果它們在綠色範圍內，則您已經超額交付（或正在超額交付）。您應該通過銷售更多 VM 或購買更便宜的硬件來優化成本。
- 期望青銅在橙色範圍內。如果它們在綠色到黃色範圍內，則您交付過多。
- 沒有應該在紅色範圍內。這是您的關鍵警報被觸發的地方。由於 KPI 的真正目的是啟用主動運營，因此您希望盡量減少處於紅色區域的情況。

在前面的例子中，白銀範圍被賦予了一個寬帶。雖然這在數學上是可能的，但在操作上它會產生不必要的複雜性。將一種顏色映射到每個服務類別要容易得多。此外，擁有 3 級以上的服務會使您的操作複雜化並增加您的成本。

讓我們看一個例子來說明：

- VM 磁盤延遲的金牌 SLA 為 8 毫秒，銅牌為 26 毫秒。
- Gold VM 007 的磁盤延遲為 9 毫秒。青銅級 VM 747 的磁盤延遲為 25 毫秒。黃金級的絕對值表現更好。但是，相對而言，Gold 級未通過 SLA，而 Bronze 級通過其 SLA。

如果您有一個沒有 SLA 的免費層級，那麼它們位於紅色區域中是可以的。商業雲提供商提供免費層。它們被有意設計為更慢且更不可靠，因為它們希望您升級和付費。

## 內部的 SLA

對於每個 SLA，可以有_許多_個關聯的 KPI，因為並非所有指標都應在合同中，而幾乎所有性能指標都需要監控。

vRealize Operations 對 vSphere IaaS 內部 SLA 使用以下閾值。這些數字在產品中是固定的。

![服務等級](1.2.7-fig-2.png)

以上是嚴格的門檻。使用了高標準的性能，因為它是基礎設施團隊消費的內部 KPI。它不是外部的、正式的 SLA。內部和外部之間需要有一個緩衝，給運營團隊反應的空間。緩衝區是您的誤差範圍。

高標準的另一個原因是它必須適用於關鍵任務環境。如果閾值對於此類環境不夠好，您將不會得到早期警告。

單個閾值用於保持操作簡單。這意味著生產環境中的性能預計會比開發環境中的得分更高。開發環境的性能顯然會比生產環境差。單個閾值有助於區分不同服務類別提供的 QoS（服務質量）差異。你付出的少，你的表現就會變差。您支付半價；你得到了一半的性能。

IaaS 的上述四個要素（CPU、內存、磁盤、網絡）在每個收集週期都進行評估。默認收集週期為 5 分鐘，這是 SLA 監控的適當平衡。基於 1 分鐘收集週期的 SLA 將過於緊張，會導致成本增加或閾值降低。

以下示例採用 vRealize Operations 8.2，表明 IaaS 為該虛擬機提供了良好的服務。它獲得了過去 24 小時內要求的四種 IaaS 資源，只有一個例外。每次 VM 未獲取資源時，圖表都會計數。未在所有四個上提供服務的 VM 將在圖表中註冊值 4。

![VM 未提供示例](1.2.7-fig-3.png)

下面的例子顯示了相反的情況。在許多實例中，VM 沒有獲得至少四種 IaaS 資源中的一種，而在一個實例中沒有獲得兩種。該圖表還顯示了 7 天，因此可以看到模式或峰值。

![尖峰圖案](1.2.7-fig-4.png)

既然我們可以測量每個虛擬機，我們可以在 ESXi 主機或集群級別匯總指標。以下公式對集群中所有正在運行的 VM 求平均值。您希望看到接近 100% 的數字，因為預期集群可以很好地為所有 VM 提供服務，而不僅僅是其中的 99%。在具有 1000 個虛擬機的集群中，99% 可能意味著 10 個虛擬機沒有得到很好的服務。只需一台虛擬機即可投訴！

![KPI 違規](1.2.7-fig-5.png)

以下示例顯示集群正在努力為其所有 VM 提供服務。

![掙扎集群](1.2.7-fig-6.png)

## KPI

我們之前分享過 SLA 只考慮通過或失敗。它不衡量你通過的有多好或你失敗的有多糟糕。這就是 KPI 補充 SLA 的地方。 KPI是在VMware Horizo​​​​n監控中實現的，所以我就以它為例。

KPI 定義為 0 - 100%。當我們使用 4 種顏色時，我們將它們平均分配。所以綠色只是 75% - 100%，紅色只是 0% - 25%。如果您創建了不均等的分佈，則某些波段將必須比其他波段更窄。對於不均勻的波段，在為構成 KPI 的每個指標定義閾值時，您還需要格外小心。

![KPI 顏色代碼](1.2.7-fig-7.png)

以下 KPI 使用 4 個指標作為其輸入。每個指標都有一組綠色、黃色、橙色和紅色的閾值。

![4 公制 KPI 著色](1.2.7-fig-8.png)

現在我們有了每個指標的閾值，我們可以將每個指標轉換為綠色 - 紅色。當整個範圍由單個數字定義時，Horizo​​​​n 適配器也能夠處理。當您想要定義 green = 0 時，這很有用。這意味著單個數據包丟失會將指標置於黃色範圍內。

我們如何翻譯？

讓我們舉一個例子。以磁盤延遲 (%) 指標為例。它的範圍從 0 到 40 毫秒，使用以下映射表映射到 0 - 100%。

![VM 磁盤延遲](1.2.7-fig-9.png)

通過上面的映射，我們可以精確地分配值。舉些例子：

- 9 毫秒的磁盤延遲轉化為 77.5% 的 KPI 值，這是綠色的。原因是綠色範圍從 75% 到 100%，其中 0 ms 等於 100%，10 ms 等於 75%。所以每毫秒大約是 2.5%。
- 42 毫秒的磁盤延遲轉化為 0%。它高於 40 毫秒的上限閾值。由於我們不顯示負數，任何高於限制的都顯示為 0%

我們對每個指標重複計算。 KPI 只是指標的平均值。

![BLAST協議丟包](1.2.7-fig-10.png)

將來，我們可以添加_加權平均值_，以便您獲得更好的領先指標。簡單平均的問題是單個紅色可以超過許多綠色，KPI 不會顯示問題。

[^1]：你看，我並不反對行話。只要它們實際用於現場操作。如果它只是一個目標，那麼就不需要用術語來標記，否則我們必須為每一種類型的目標創建術語。